name: Deploy on Push
on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      
      - run: npm ci || npm install
      - run: npm run build || npm run build:fast
      
      # Firebase CLI 설치
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      # Firebase 프로젝트 설정
      - name: Setup Firebase Project
        run: firebase use tour-guider-homepage
      
      # Firebase 배포 (토큰이 있으면 사용, 없으면 건너뛰기)
      - name: Firebase Deploy
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          if [ -n "$FIREBASE_TOKEN" ]; then
            echo "Firebase 토큰이 설정되어 배포를 진행합니다..."
            firebase deploy --only hosting --token "$FIREBASE_TOKEN"
          else
            echo "⚠️ FIREBASE_TOKEN이 설정되지 않아 배포를 건너뜁니다."
            echo "GitHub Secrets에 FIREBASE_TOKEN을 추가하세요."
            echo "토큰 생성 방법: firebase login:ci (로컬에서 실행)"
          fi
      
      - name: Verify
        run: npm run verify:all || echo "verify skipped"


